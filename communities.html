<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¬ØªÙ…Ø¹Ø§ØªÙ†Ø§</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
    <style>
        /* Reset & Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            padding: 15px 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            text-decoration: none;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }

        .auth-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .auth-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        /* Main Content */
        .main-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .page-title {
            text-align: center;
            margin-bottom: 30px;
        }

        .page-title h1 {
            color: #2d3748;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .page-title p {
            color: #718096;
            font-size: 18px;
        }

        /* Actions Bar */
        .actions-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-btn {
            padding: 12px 25px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            transition: border 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .create-btn {
            padding: 12px 25px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .create-btn:hover {
            background: #38a169;
            transform: translateY(-2px);
        }

        /* Communities Grid */
        .communities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        /* Community Card */
        .community-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s;
            border: 2px solid #f7fafc;
        }

        .community-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .card-header {
            padding: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: relative;
        }

        .card-header.private {
            background: linear-gradient(135deg, #ed64a6 0%, #805ad5 100%);
        }

        .community-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255,255,255,0.95);
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .community-badge.public {
            color: #667eea;
        }

        .community-badge.private {
            color: #ed64a6;
        }

        .community-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .card-content {
            padding: 25px;
        }

        .community-name {
            font-size: 22px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .community-desc {
            color: #718096;
            line-height: 1.6;
            margin-bottom: 20px;
            font-size: 15px;
        }

        .community-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f7fafc;
        }

        .stat {
            flex: 1;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 13px;
            color: #a0aec0;
            margin-top: 5px;
        }

        .card-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s;
        }

        .action-btn.join {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .action-btn.join:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
            transform: translateY(-2px);
        }

        .action-btn.view {
            background: #f7fafc;
            color: #4a5568;
        }

        .action-btn.view:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
        }

        .action-btn.joined {
            background: #c6f6d5;
            color: #22543d;
            cursor: default;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 25px;
            border-bottom: 2px solid #f7fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: #2d3748;
            font-size: 24px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #a0aec0;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #f7fafc;
            color: #4a5568;
        }

        .modal-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
            font-size: 15px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
            transform: translateY(-2px);
        }

        /* Chat Modal */
        .chat-modal .modal {
            max-width: 800px;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 20px 20px 0 0;
        }

        .chat-header.private {
            background: linear-gradient(135deg, #ed64a6 0%, #805ad5 100%);
        }

        .chat-info h2 {
            font-size: 26px;
            margin-bottom: 5px;
        }

        .chat-info p {
            opacity: 0.9;
            font-size: 16px;
        }

        .chat-body {
            display: flex;
            min-height: 400px;
            max-height: 500px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f7fafc;
        }

        .message {
            background: white;
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            animation: messageAppear 0.3s ease;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .message-author {
            font-weight: bold;
            color: #4a5568;
            font-size: 16px;
        }

        .message-time {
            color: #a0aec0;
            font-size: 13px;
        }

        .message-content {
            color: #2d3748;
            line-height: 1.5;
            font-size: 15px;
        }

        .chat-input-section {
            padding: 20px;
            border-top: 2px solid #f7fafc;
            background: white;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .input-group input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group button {
            padding: 15px 25px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s;
        }

        .input-group button:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
            transform: translateY(-2px);
        }

        /* Share Section */
        .share-section {
            background: #f0f4ff;
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .share-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: #4a5568;
            font-weight: 600;
            font-size: 16px;
        }

        .share-box {
            display: flex;
            gap: 10px;
            background: white;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
        }

        .share-box input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 15px;
            color: #4a5568;
            background: transparent;
        }

        .copy-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .copy-btn.copied {
            background: #48bb78;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
            font-size: 18px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .communities-grid {
                grid-template-columns: 1fr;
            }
            
            .actions-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                min-width: auto;
            }
            
            .chat-body {
                flex-direction: column;
            }
        }

        /* Auth Modal */
        .auth-modal .modal {
            max-width: 400px;
        }

        .auth-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-option {
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
        }

        .auth-option:hover {
            border-color: #667eea;
            background: #f7fafc;
            transform: translateY(-2px);
        }

        .auth-icon {
            font-size: 24px;
        }

        .auth-text {
            flex: 1;
        }

        .auth-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .auth-desc {
            color: #718096;
            font-size: 14px;
        }

        /* Error Message */
        .error-message {
            background: #fed7d7;
            color: #9b2c2c;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 2px solid #fc8181;
        }

        /* Success Message */
        .success-message {
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 2px solid #9ae6b4;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 30px;
            color: white;
            margin-top: 40px;
            font-size: 15px;
        }
    </style>
</head>
<body>
    <!-- Firebase Configuration -->
    <script>
        // Firebase Config - Ø­Ø· Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù‡Ù†Ø§
        const firebaseConfig = {
            apiKey: "AIzaSyCo7Hlzb0-C1v6C9rdDbzVg_Nvp_J1MW64",
            authDomain: "tribly-app.firebaseapp.com",
            databaseURL: "https://tribly-app-default-rtdb.firebaseio.com",
            projectId: "tribly-app",
            storageBucket: "tribly-app.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abc123def456ghi789"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
    </script>

    <!-- Header -->
    <header class="header">
        <div class="logo">Ù…Ø¬ØªÙ…Ø¹Ø§ØªÙ†Ø§</div>
        <div class="user-section">
            <div class="user-avatar" id="userAvatar">?</div>
            <button class="auth-btn" id="authBtn" onclick="showAuthModal()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <div class="main-content">
            <div class="page-title">
                <h1>ğŸŒ Ù…Ø¬ØªÙ…Ø¹Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©</h1>
                <p>Ù…Ø¬ØªÙ…Ø¹Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„ÙƒÙ„ØŒ ÙˆØ¨ØªØ´ØªØºÙ„ Ù…Ø¹ ØµØ­Ø§Ø¨Ùƒ Ù…Ù† Ø£ÙŠ Ù…ÙƒØ§Ù†</p>
            </div>

            <!-- Actions Bar -->
            <div class="actions-bar">
                <button class="filter-btn active" onclick="filterCommunities('all')">
                    <span>ğŸ“‹</span> Ø§Ù„ÙƒÙ„
                </button>
                <button class="filter-btn" onclick="filterCommunities('public')">
                    <span>ğŸŒ</span> Ø¹Ø§Ù…Ø©
                </button>
                <button class="filter-btn" onclick="filterCommunities('private')">
                    <span>ğŸ”’</span> Ø®Ø§ØµØ©
                </button>
                
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¬ØªÙ…Ø¹..." oninput="searchCommunities()">
                </div>
                
                <button class="create-btn" onclick="showCreateModal()">
                    <span>â•</span> Ù…Ø¬ØªÙ…Ø¹ Ø¬Ø¯ÙŠØ¯
                </button>
            </div>

            <!-- Communities Grid -->
            <div class="communities-grid" id="communitiesGrid">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Create Community Modal -->
    <div class="modal-overlay" id="createModal">
        <div class="modal">
            <div class="modal-header">
                <h2>â• Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬ØªÙ…Ø¹ Ø¬Ø¯ÙŠØ¯</h2>
                <button class="close-btn" onclick="hideCreateModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="communityForm">
                    <div class="form-group">
                        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¬ØªÙ…Ø¹</label>
                        <input type="text" id="communityName" placeholder="Ù…Ø«Ù„: ÙØ±ÙŠÙ‚ ÙƒØ±Ø© Ø§Ù„Ù‚Ø¯Ù…" required>
                    </div>
                    
                    <div class="form-group">
                        <label>ÙˆØµÙ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹</label>
                        <textarea id="communityDesc" placeholder="Ø§Ø´Ø±Ø­ Ù‡Ø¯Ù Ø§Ù„Ù…Ø¬ØªÙ…Ø¹"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹</label>
                        <select id="communityType" onchange="togglePasswordField()">
                            <option value="public">ğŸŒ Ø¹Ø§Ù… (Ø£ÙŠ Ø­Ø¯ ÙŠØ¯Ø®Ù„)</option>
                            <option value="private">ğŸ”’ Ø®Ø§Øµ (Ø¨ÙƒÙ„Ù…Ø© Ø³Ø±)</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="passwordField" style="display: none;">
                        <label>ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
                        <input type="password" id="communityPassword" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± Ù‚ÙˆÙŠØ©">
                    </div>
                    
                    <button type="submit" class="submit-btn">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div class="modal-overlay" id="chatModal">
        <div class="modal chat-modal">
            <div class="chat-header" id="chatHeader">
                <div class="chat-info">
                    <h2 id="chatTitle">...</h2>
                    <p id="chatDesc">...</p>
                </div>
            </div>
            
            <div class="chat-body">
                <div class="chat-messages" id="chatMessages">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©...</p>
                    </div>
                </div>
            </div>
            
            <div class="chat-input-section">
                <div class="input-group">
                    <input type="text" id="messageInput" placeholder="âœï¸ Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." onkeypress="handleEnter(event)">
                    <button onclick="sendMessage()">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„</button>
                </div>
                
                <div class="share-section" id="shareSection">
                    <div class="share-header">
                        <span>ğŸ”—</span>
                        <span>Ø´Ø§Ø±Ùƒ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¹ ØµØ­Ø§Ø¨Ùƒ</span>
                    </div>
                    <div class="share-box">
                        <input type="text" id="communityLink" readonly>
                        <button class="copy-btn" onclick="copyCommunityLink()">Ù†Ø³Ø®</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Join Modal -->
    <div class="modal-overlay" id="joinModal">
        <div class="modal">
            <div class="modal-header">
                <h2>ğŸ”’ Ø§Ù†Ø¶Ù… Ù„Ù„Ù…Ø¬ØªÙ…Ø¹ Ø§Ù„Ø®Ø§Øµ</h2>
                <button class="close-btn" onclick="hideJoinModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="joinForm">
                    <div class="form-group">
                        <label>Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:</label>
                        <input type="password" id="joinPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" required>
                    </div>
                    <button type="submit" class="submit-btn">Ø¯Ø®ÙˆÙ„</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="modal auth-modal">
            <div class="modal-header">
                <h2>ğŸ‘‹ Ø§Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹</h2>
                <button class="close-btn" onclick="hideAuthModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="auth-options">
                    <div class="auth-option" onclick="signInWithGoogle()">
                        <div class="auth-icon">ğŸ”‘</div>
                        <div class="auth-text">
                            <div class="auth-title">ØªØ³Ø¬ÙŠÙ„ Ø³Ø±ÙŠØ¹</div>
                            <div class="auth-desc">Ø§Ø®ØªØ± Ø§Ø³Ù… ÙˆØ§Ø¨Ø¯Ø£ Ù…Ø¨Ø§Ø´Ø±Ø©</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>Â© 2024 Ù…Ø¬ØªÙ…Ø¹Ø§ØªÙ†Ø§ - ÙƒÙ„ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù„Ù‰ Firebase Ù„Ù„Ø¬Ù…ÙŠØ¹</p>
    </footer>

    <script>
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        let currentUser = null;
        let communities = {};
        let currentCommunityId = null;
        let currentFilter = 'all';
        let joinedCommunities = {};

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        document.addEventListener('DOMContentLoaded', async function() {
            await initApp();
        });

        // ØªÙ‡ÙŠØ¦Ø© Firebase ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚
        async function initApp() {
            try {
                showLoading();
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª Ù…Ù† Firebase
                await loadCommunities();
                
                // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù† ÙˆØ¬Ø¯
                await loadUserData();
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
                checkUrlForCommunity();
                
                renderCommunities();
            } catch (error) {
                console.error('Error initializing app:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚');
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª Ù…Ù† Firebase
        async function loadCommunities() {
            try {
                const snapshot = await database.ref('communities').once('value');
                communities = snapshot.val() || {};
                console.log('Communities loaded:', communities);
            } catch (error) {
                console.error('Error loading communities:', error);
                throw error;
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        async function loadUserData() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateUserUI();
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª Ø§Ù„Ù…Ù†Ø¶Ù… Ù„Ù‡Ø§
                await loadJoinedCommunities();
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª Ø§Ù„Ù…Ù†Ø¶Ù… Ù„Ù‡Ø§
        async function loadJoinedCommunities() {
            try {
                const snapshot = await database.ref(`userCommunities/${currentUser.id}`).once('value');
                joinedCommunities = snapshot.val() || {};
            } catch (error) {
                console.error('Error loading joined communities:', error);
            }
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª
        function renderCommunities() {
            const grid = document.getElementById('communitiesGrid');
            
            if (!communities || Object.keys(communities).length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ¢</div>
                        <h3 style="color: #4a5568; margin-bottom: 10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬ØªÙ…Ø¹Ø§Øª Ø¨Ø¹Ø¯</h3>
                        <p style="color: #718096;">ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠÙ†Ø´Ø¦ Ù…Ø¬ØªÙ…Ø¹!</p>
                    </div>
                `;
                return;
            }

            let filteredCommunities = Object.entries(communities);

            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ©
            if (currentFilter === 'public') {
                filteredCommunities = filteredCommunities.filter(([id, community]) => community.type === 'public');
            } else if (currentFilter === 'private') {
                filteredCommunities = filteredCommunities.filter(([id, community]) => community.type === 'private');
            }

            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø«
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filteredCommunities = filteredCommunities.filter(([id, community]) =>
                    community.name.toLowerCase().includes(searchTerm) ||
                    (community.description || '').toLowerCase().includes(searchTerm)
                );
            }

            // ÙØ±Ø² Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
            filteredCommunities.sort((a, b) => b[1].createdAt - a[1].createdAt);

            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒØ±ÙˆØª
            let html = '';
            filteredCommunities.forEach(([id, community]) => {
                const isJoined = currentUser && joinedCommunities[id];
                
                html += `
                    <div class="community-card">
                        <div class="card-header ${community.type}">
                            <div class="community-badge ${community.type}">
                                ${community.type === 'public' ? 'ğŸŒ Ø¹Ø§Ù…' : 'ğŸ”’ Ø®Ø§Øµ'}
                            </div>
                            <div class="community-icon">${community.icon || 'ğŸ‘¥'}</div>
                            <div class="community-name" style="color: white;">${community.name}</div>
                        </div>
                        <div class="card-content">
                            <div class="community-desc">${community.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</div>
                            <div class="community-stats">
                                <div class="stat">
                                    <div class="stat-number">${community.members || 1}</div>
                                    <div class="stat-label">Ø£Ø¹Ø¶Ø§Ø¡</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-number">${community.messageCount || 0}</div>
                                    <div class="stat-label">Ø±Ø³Ø§Ø¦Ù„</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-number">${community.moderators ? Object.keys(community.moderators).length : 1}</div>
                                    <div class="stat-label">Ù…Ø´Ø±ÙÙŠÙ†</div>
                                </div>
                            </div>
                            <div class="card-actions">
                                <button class="action-btn ${isJoined ? 'joined' : 'join'}" 
                                        onclick="handleCommunityAction('${id}')"
                                        ${!currentUser ? 'disabled' : ''}>
                                    ${isJoined ? 'âœ… Ø¹Ø¶Ùˆ' : 'Ø§Ù†Ø¶Ù…'}
                                </button>
                                <button class="action-btn view" onclick="openChat('${id}')">
                                    Ø¹Ø±Ø¶
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            grid.innerHTML = html || `
                <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #718096;">
                    Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬ØªÙ…Ø¹Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø¨Ø­Ø«Ùƒ
                </div>
            `;
        }

        // ØªØµÙÙŠØ© Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª
        function filterCommunities(type) {
            currentFilter = type;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø´Ø·Ø©
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderCommunities();
        }

        // Ø¨Ø­Ø« Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª
        function searchCommunities() {
            renderCommunities();
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹
        function signInWithGoogle() {
            const userName = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ (Ù…Ù…ÙƒÙ† ØªØ®Ù„ÙŠÙ‡ Ù…Ø³ØªØ¹Ø§Ø±):');
            if (userName && userName.trim()) {
                currentUser = {
                    id: Date.now().toString(),
                    name: userName.trim(),
                    avatar: userName.charAt(0).toUpperCase()
                };
                
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                updateUserUI();
                hideAuthModal();
                showSuccess(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${userName}!`);
            }
        }

        function updateUserUI() {
            const avatar = document.getElementById('userAvatar');
            const authBtn = document.getElementById('authBtn');
            
            if (currentUser) {
                avatar.textContent = currentUser.avatar;
                authBtn.textContent = currentUser.name;
            } else {
                avatar.textContent = '?';
                authBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
            }
        }

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù†Ø¶Ù…Ø§Ù…/Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ù…Ø¬ØªÙ…Ø¹
        async function handleCommunityAction(communityId) {
            if (!currentUser) {
                showAuthModal();
                return;
            }

            const community = communities[communityId];
            if (!community) return;

            const isJoined = joinedCommunities[communityId];

            if (isJoined) {
                // Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ù…Ø¬ØªÙ…Ø¹
                if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…ØºØ§Ø¯Ø±Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ØŸ')) {
                    await leaveCommunity(communityId);
                }
            } else {
                // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù…Ø¬ØªÙ…Ø¹
                if (community.type === 'private') {
                    currentCommunityId = communityId;
                    showJoinModal();
                } else {
                    await joinCommunity(communityId);
                }
            }
        }

        // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù…Ø¬ØªÙ…Ø¹
        async function joinCommunity(communityId) {
            try {
                const communityRef = database.ref(`communities/${communityId}`);
                
                // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
                const community = communities[communityId];
                const newMemberCount = (community.members || 1) + 1;
                
                await communityRef.update({
                    members: newMemberCount
                });

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª Ø§Ù„Ù…Ù†Ø¶Ù… Ù„Ù‡Ø§
                await database.ref(`userCommunities/${currentUser.id}/${communityId}`).set(true);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                communities[communityId].members = newMemberCount;
                joinedCommunities[communityId] = true;
                
                renderCommunities();
                showSuccess('ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù…Ø¬ØªÙ…Ø¹ Ø¨Ù†Ø¬Ø§Ø­!');
                
                // ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
                openChat(communityId);
                
            } catch (error) {
                console.error('Error joining community:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…');
            }
        }

        // Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ù…Ø¬ØªÙ…Ø¹
        async function leaveCommunity(communityId) {
            try {
                const communityRef = database.ref(`communities/${communityId}`);
                
                // ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
                const community = communities[communityId];
                const newMemberCount = Math.max(0, (community.members || 1) - 1);
                
                await communityRef.update({
                    members: newMemberCount
                });

                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª Ø§Ù„Ù…Ù†Ø¶Ù… Ù„Ù‡Ø§
                await database.ref(`userCommunities/${currentUser.id}/${communityId}`).remove();
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                communities[communityId].members = newMemberCount;
                delete joinedCommunities[communityId];
                
                renderCommunities();
                showSuccess('ØªÙ… Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ù…Ø¬ØªÙ…Ø¹');
                
            } catch (error) {
                console.error('Error leaving community:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©');
            }
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬ØªÙ…Ø¹ Ø¬Ø¯ÙŠØ¯
        document.getElementById('communityForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentUser) {
                showAuthModal();
                return;
            }
            
            const name = document.getElementById('communityName').value.trim();
            const description = document.getElementById('communityDesc').value.trim();
            const type = document.getElementById('communityType').value;
            const password = type === 'private' ? document.getElementById('communityPassword').value : null;
            
            if (!name) {
                showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬ØªÙ…Ø¹');
                return;
            }
            
            try {
                const communityId = Date.now().toString();
                const communityRef = database.ref(`communities/${communityId}`);
                
                const newCommunity = {
                    id: communityId,
                    name: name,
                    description: description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ',
                    type: type,
                    icon: type === 'private' ? 'ğŸ”’' : 'ğŸ‘¥',
                    members: 1,
                    messageCount: 0,
                    createdAt: Date.now(),
                    createdBy: currentUser.id,
                    moderators: {
                        [currentUser.id]: true
                    }
                };
                
                if (type === 'private' && password) {
                    newCommunity.password = password;
                }
                
                // Ø­ÙØ¸ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ ÙÙŠ Firebase
                await communityRef.set(newCommunity);
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒØ¹Ø¶Ùˆ
                await database.ref(`userCommunities/${currentUser.id}/${communityId}`).set(true);
                
                // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨
                await database.ref(`messages/${communityId}`).push().set({
                    userId: 'system',
                    userName: 'Ø§Ù„Ù†Ø¸Ø§Ù…',
                    text: `ğŸ‰ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ "${name}" Ø¨ÙˆØ§Ø³Ø·Ø© ${currentUser.name}!`,
                    timestamp: Date.now(),
                    type: 'system'
                });
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                communities[communityId] = newCommunity;
                joinedCommunities[communityId] = true;
                
                hideCreateModal();
                renderCommunities();
                showSuccess(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ "${name}" Ø¨Ù†Ø¬Ø§Ø­!`);
                
                // ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
                setTimeout(() => openChat(communityId), 500);
                
            } catch (error) {
                console.error('Error creating community:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹');
            }
        });

        // ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        async function openChat(communityId) {
            const community = communities[communityId];
            if (!community) return;
            
            currentCommunityId = communityId;
            const isJoined = currentUser && joinedCommunities[communityId];
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
            document.getElementById('chatTitle').textContent = community.name;
            document.getElementById('chatDesc').textContent = community.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ';
            document.getElementById('chatHeader').className = `chat-header ${community.type}`;
            
            // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
            document.getElementById('shareSection').style.display = isJoined ? 'block' : 'none';
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø·
            const link = `${window.location.origin}${window.location.pathname}?community=${communityId}`;
            document.getElementById('communityLink').value = link;
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
            await loadMessages(communityId);
            
            // ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
            document.getElementById('chatModal').classList.add('active');
            
            // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
            setTimeout(() => {
                document.getElementById('messageInput').focus();
            }, 100);
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            setupMessageListener(communityId);
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        async function loadMessages(communityId) {
            const messagesDiv = document.getElementById('chatMessages');
            const isJoined = currentUser && joinedCommunities[communityId];
            
            if (!isJoined) {
                messagesDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #718096;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ”’</div>
                        <h3 style="margin-bottom: 10px;">ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù…Ø¬ØªÙ…Ø¹</h3>
                        <p style="margin-bottom: 20px;">Ø§Ù†Ø¶Ù… Ù„Ù„Ù…Ø¬ØªÙ…Ø¹ Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</p>
                        <button class="action-btn join" onclick="handleCommunityAction('${communityId}')">
                            Ø§Ù†Ø¶Ù… Ø§Ù„Ø¢Ù†
                        </button>
                    </div>
                `;
                return;
            }
            
            try {
                const snapshot = await database.ref(`messages/${communityId}`).once('value');
                const messages = snapshot.val();
                
                if (!messages || Object.keys(messages).length === 0) {
                    messagesDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #718096;">
                            <div style="font-size: 48px; margin-bottom: 20px;">ğŸ’¬</div>
                            <h3 style="margin-bottom: 10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯</h3>
                            <p>ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ±Ø³Ù„ Ø±Ø³Ø§Ù„Ø©!</p>
                        </div>
                    `;
                    return;
                }
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ù…ØµÙÙˆÙØ© ÙˆÙØ±Ø²Ù‡Ø§
                const messagesArray = Object.values(messages).sort((a, b) => a.timestamp - b.timestamp);
                
                let html = '';
                messagesArray.forEach(msg => {
                    const time = formatTime(msg.timestamp);
                    const isSystem = msg.type === 'system';
                    
                    html += `
                        <div class="message">
                            <div class="message-header">
                                <span class="message-author" style="${isSystem ? 'color: #718096;' : ''}">
                                    ${isSystem ? 'ğŸ”” ' : ''}${msg.userName}
                                </span>
                                <span class="message-time">${time}</span>
                            </div>
                            <div class="message-content" style="${isSystem ? 'color: #718096; font-style: italic;' : ''}">
                                ${msg.text}
                            </div>
                        </div>
                    `;
                });
                
                messagesDiv.innerHTML = html;
                
                // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„
                setTimeout(() => {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }, 100);
                
            } catch (error) {
                console.error('Error loading messages:', error);
                messagesDiv.innerHTML = '<div class="error-message">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>';
            }
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        function setupMessageListener(communityId) {
            const messagesRef = database.ref(`messages/${communityId}`);
            
            messagesRef.on('child_added', async (snapshot) => {
                const msg = snapshot.val();
                const messagesDiv = document.getElementById('chatMessages');
                
                if (messagesDiv && !messagesDiv.innerHTML.includes('ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…')) {
                    const time = formatTime(msg.timestamp);
                    const isSystem = msg.type === 'system';
                    
                    const messageHtml = `
                        <div class="message">
                            <div class="message-header">
                                <span class="message-author" style="${isSystem ? 'color: #718096;' : ''}">
                                    ${isSystem ? 'ğŸ”” ' : ''}${msg.userName}
                                </span>
                                <span class="message-time">${time}</span>
                            </div>
                            <div class="message-content" style="${isSystem ? 'color: #718096; font-style: italic;' : ''}">
                                ${msg.text}
                            </div>
                        </div>
                    `;
                    
                    messagesDiv.innerHTML += messageHtml;
                    
                    // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„
                    setTimeout(() => {
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }, 100);
                }
            });
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
        async function sendMessage() {
            if (!currentUser || !currentCommunityId) return;
            
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©
            if (!joinedCommunities[currentCommunityId]) {
                showError('ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù…Ø¬ØªÙ…Ø¹ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            try {
                const messageRef = database.ref(`messages/${currentCommunityId}`).push();
                
                await messageRef.set({
                    userId: currentUser.id,
                    userName: currentUser.name,
                    text: message,
                    timestamp: Date.now(),
                    type: 'message'
                });

                // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                const communityRef = database.ref(`communities/${currentCommunityId}`);
                const community = communities[currentCommunityId];
                const newMessageCount = (community.messageCount || 0) + 1;
                
                await communityRef.update({
                    messageCount: newMessageCount
                });
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                communities[currentCommunityId].messageCount = newMessageCount;
                
                input.value = '';
                input.focus();
                
            } catch (error) {
                console.error('Error sending message:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
            }
        }

        // Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¬ØªÙ…Ø¹
        function copyCommunityLink() {
            const linkInput = document.getElementById('communityLink');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            
            navigator.clipboard.writeText(linkInput.value)
                .then(() => {
                    const btn = event.target;
                    btn.textContent = 'ØªÙ… Ø§Ù„Ù†Ø³Ø®!';
                    btn.classList.add('copied');
                    setTimeout(() => {
                        btn.textContent = 'Ù†Ø³Ø®';
                        btn.classList.remove('copied');
                    }, 2000);
                })
                .catch(err => {
                    showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·');
                });
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        function checkUrlForCommunity() {
            const urlParams = new URLSearchParams(window.location.search);
            const communityId = urlParams.get('community');
            
            if (communityId && communities[communityId]) {
                const community = communities[communityId];
                
                if (community.type === 'public') {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ø§Ù…ØŒ Ø§ÙØªØ­Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©
                    openChat(communityId);
                } else if (currentUser && joinedCommunities[communityId]) {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø®Ø§Øµ ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø¶ÙˆØŒ Ø§ÙØªØ­Ù‡
                    openChat(communityId);
                } else {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø®Ø§ØµØŒ Ø§Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
                    currentCommunityId = communityId;
                    setTimeout(() => showJoinModal(), 1000);
                }
            }
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø²Ø± Enter
        function handleEnter(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
        function formatTime(timestamp) {
            if (!timestamp) return 'Ø§Ù„Ø¢Ù†';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (seconds < 60) return 'Ø§Ù„Ø¢Ù†';
            if (minutes < 60) return `Ù‚Ø¨Ù„ ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
            if (hours < 24) return `Ù‚Ø¨Ù„ ${hours} Ø³Ø§Ø¹Ø©`;
            if (days < 7) return `Ù‚Ø¨Ù„ ${days} ÙŠÙˆÙ…`;
            
            return date.toLocaleDateString('ar-SA');
        }

        // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ø±Ø¶/Ø§Ù„Ø¥Ø®ÙØ§Ø¡
        function showAuthModal() {
            document.getElementById('authModal').classList.add('active');
        }

        function hideAuthModal() {
            document.getElementById('authModal').classList.remove('active');
        }

        function showCreateModal() {
            if (!currentUser) {
                showAuthModal();
                return;
            }
            document.getElementById('createModal').classList.add('active');
        }

        function hideCreateModal() {
            document.getElementById('createModal').classList.remove('active');
            document.getElementById('communityForm').reset();
        }

        function showJoinModal() {
            if (!currentUser) {
                showAuthModal();
                return;
            }
            document.getElementById('joinModal').classList.add('active');
        }

        function hideJoinModal() {
            document.getElementById('joinModal').classList.remove('active');
            document.getElementById('joinPassword').value = '';
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù…Ø¬ØªÙ…Ø¹ Ø®Ø§Øµ
        document.getElementById('joinForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentUser || !currentCommunityId) return;
            
            const password = document.getElementById('joinPassword').value;
            const community = communities[currentCommunityId];
            
            if (community.password === password) {
                await joinCommunity(currentCommunityId);
                hideJoinModal();
                openChat(currentCommunityId);
            } else {
                showError('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            }
        });

        function togglePasswordField() {
            const type = document.getElementById('communityType').value;
            const passwordField = document.getElementById('passwordField');
            passwordField.style.display = type === 'private' ? 'block' : 'none';
        }

        // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
        function showLoading() {
            // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© spinner Ø¥Ø°Ø§ Ù„Ø²Ù…
        }

        function showError(message) {
            alert(`âŒ ${message}`);
        }

        function showSuccess(message) {
            alert(`âœ… ${message}`);
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                    currentCommunityId = null;
                }
            });
        });

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬
        document.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                this.closest('.modal-overlay').classList.remove('active');
                currentCommunityId = null;
            });
        });

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        document.getElementById('chatModal').addEventListener('click', function(e) {
            if (e.target === this) {
                currentCommunityId = null;
            }
        });
    </script>
</body>
</html>