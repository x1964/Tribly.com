<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=5.0">
  <meta name="theme-color" content="#6ae44d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª - Tribly</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getDatabase, ref, set, get, push, onValue, update, remove, onChildAdded } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

    // Firebase configuration - Ø§Ø¶Ø¨Ø· Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù‡Ù†Ø§
    const firebaseConfig = {
      apiKey: "AIzaSyCR4VvolsS8f3gGVnD-C77tQSZFBir_5ks",
      authDomain: "tribly-80946.firebaseapp.com",
      databaseURL: "https://tribly-80946-default-rtdb.firebaseio.com",
      projectId: "tribly-80946",
      storageBucket: "tribly-80946.firebasestorage.app",
      messagingSenderId: "126255005792",
      appId: "1:126255005792:web:5030587c2dcec668458305"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth(app);
    
    // Ø¬Ø¹Ù„ Firebase Ù…ØªØ§Ø­Ø§Ù‹ Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù…
    window.firebase = {
      app,
      database,
      auth,
      db: {
        ref, set, get, push, onValue, update, remove, onChildAdded
      },
      authFunctions: {
        GoogleAuthProvider,
        signInWithPopup,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        updateProfile
      }
    };
    
    console.log("âœ… Firebase initialized successfully!");
    
    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof window.initApp === 'function') {
        window.initApp();
      }
    });
  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      color: #333;
    }

    /* Navbar */
    nav {
      background: white;
      padding: 1rem 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .logo {
      font-size: 1.8rem;
      font-weight: bold;
      color: #6ae44d;
      text-decoration: none;
    }

    .nav-links {
      display: flex;
      list-style: none;
      gap: 2rem;
    }

    .nav-links a {
      text-decoration: none;
      color: #333;
      font-weight: 500;
      transition: color 0.3s;
    }

    .nav-links a:hover {
      color: #6ae44d;
    }

    .nav-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-section {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6ae44d, #a5ff84);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .auth-btn {
      padding: 8px 16px;
      background: #6ae44d;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.3s;
    }

    .auth-btn:hover {
      background: #5ac93d;
    }

    /* Main Container */
    .container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    .page-header {
      text-align: center;
      margin-bottom: 3rem;
    }

    .page-header h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      color: #222;
    }

    .page-header p {
      font-size: 1.1rem;
      color: #666;
    }

    /* Filter Section */
    .filter-section {
      background: white;
      padding: 1.5rem;
      border-radius: 15px;
      margin-bottom: 2rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .filter-btn {
      padding: 0.75rem 1.5rem;
      border: 2px solid #ddd;
      background: white;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .filter-btn.active {
      background: #6ae44d;
      color: white;
      border-color: #6ae44d;
    }

    .filter-btn:hover {
      border-color: #6ae44d;
    }

    .search-box {
      flex: 1;
      min-width: 250px;
    }

    .search-box input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid #ddd;
      border-radius: 25px;
      font-size: 1rem;
      transition: border 0.3s;
    }

    .search-box input:focus {
      outline: none;
      border-color: #6ae44d;
    }

    /* Communities Grid */
    .communities-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 2rem;
      margin-bottom: 3rem;
    }

    /* Community Card */
    .community-card {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: all 0.3s;
      cursor: pointer;
    }

    .community-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .community-header {
      background: linear-gradient(135deg, #6ae44d, #a5ff84);
      padding: 2rem;
      position: relative;
      min-height: 150px;
      display: flex;
      align-items: flex-end;
    }

    .community-header.private {
      background: linear-gradient(135deg, #667eea, #764ba2);
    }

    .community-icon {
      font-size: 3rem;
      color: white;
      margin-bottom: 1rem;
    }

    .community-badge {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(255,255,255,0.9);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .community-badge.public {
      color: #6ae44d;
    }

    .community-badge.private {
      color: #667eea;
    }

    .community-info {
      padding: 1.5rem;
    }

    .community-name {
      font-size: 1.5rem;
      font-weight: bold;
      color: #222;
      margin-bottom: 0.5rem;
    }

    .community-desc {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 1rem;
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .community-stats {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #eee;
    }

    .stat {
      flex: 1;
      text-align: center;
    }

    .stat-number {
      font-size: 1.3rem;
      font-weight: bold;
      color: #6ae44d;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #999;
      margin-top: 0.25rem;
    }

    .community-footer {
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      flex: 1;
      padding: 0.75rem;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.9rem;
    }

    .btn-primary {
      background: #6ae44d;
      color: white;
    }

    .btn-primary:hover {
      background: #5ac93d;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 2rem;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalSlide 0.3s ease;
    }

    @keyframes modalSlide {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #eee;
    }

    .modal-header h2 {
      font-size: 1.5rem;
      color: #222;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #999;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .close-btn:hover {
      background: #f5f5f5;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #333;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      font-family: inherit;
      transition: border 0.3s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #6ae44d;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Chat Modal */
    .chat-modal .modal-content {
      max-width: 800px;
    }

    .detail-header {
      background: linear-gradient(135deg, #6ae44d, #a5ff84);
      padding: 2rem;
      color: white;
      border-radius: 15px 15px 0 0;
    }

    .detail-header.private {
      background: linear-gradient(135deg, #667eea, #764ba2);
    }

    .detail-content {
      padding: 2rem;
    }

    .detail-section {
      margin-bottom: 2rem;
    }

    .detail-section h3 {
      font-size: 1.3rem;
      margin-bottom: 1rem;
      color: #222;
    }

    .members-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
    }

    .member-card {
      background: #f5f5f5;
      padding: 1rem;
      border-radius: 10px;
      text-align: center;
    }

    .member-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6ae44d, #a5ff84);
      color: white;
      margin: 0 auto 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: bold;
    }

    .member-name {
      font-weight: 600;
      color: #333;
      font-size: 0.9rem;
    }

    .member-role {
      font-size: 0.75rem;
      color: #999;
      margin-top: 0.25rem;
    }

    /* Chat Section */
    .chat-section {
      background: #f9f9f9;
      border-radius: 15px;
      padding: 1.5rem;
      margin-top: 2rem;
    }

    .chat-container {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 1rem;
      padding: 1rem;
      background: white;
      border-radius: 10px;
    }

    .message {
      background: white;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      border-left: 4px solid #6ae44d;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .message.system {
      border-left-color: #999;
      background: #f8f9fa;
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .message-author {
      font-weight: 600;
      color: #333;
    }

    .message-time {
      font-size: 0.8rem;
      color: #999;
    }

    .message-content {
      color: #666;
      line-height: 1.5;
    }

    .message-input {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .message-input input {
      flex: 1;
      padding: 0.75rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }

    .message-input button {
      background: #6ae44d;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }

    .message-input button:hover {
      background: #5ac93d;
    }

    /* Share Section */
    .share-section {
      background: linear-gradient(135deg, rgba(106, 228, 77, 0.1), rgba(165, 255, 132, 0.1));
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1rem 0;
      border: 2px dashed #6ae44d;
    }

    .share-box {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .share-box input {
      flex: 1;
      padding: 0.75rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 0.9rem;
      background: white;
    }

    .copy-btn {
      padding: 0.75rem 1.5rem;
      background: #6ae44d;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }

    .copy-btn:hover {
      background: #5ac93d;
    }

    .copy-btn.copied {
      background: #27ae60;
    }

    /* Auth Modal */
    .auth-modal .modal-content {
      max-width: 400px;
    }

    .auth-options {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1rem;
    }

    .auth-option {
      padding: 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .auth-option:hover {
      border-color: #6ae44d;
      background: #f9fff9;
      transform: translateY(-2px);
    }

    .auth-icon {
      font-size: 1.5rem;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f0f0f0;
      border-radius: 8px;
    }

    .auth-text {
      flex: 1;
    }

    .auth-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 0.25rem;
    }

    .auth-desc {
      font-size: 0.85rem;
      color: #666;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 3rem;
      color: #666;
    }

    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #6ae44d;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      nav {
        padding: 1rem;
      }

      .nav-links {
        display: none;
      }

      .page-header h1 {
        font-size: 1.8rem;
      }

      .communities-grid {
        grid-template-columns: 1fr;
      }

      .filter-section {
        flex-direction: column;
      }

      .search-box {
        width: 100%;
      }

      .detail-header {
        padding: 1.5rem;
      }

      .detail-content {
        padding: 1rem;
      }

      .members-list {
        grid-template-columns: repeat(2, 1fr);
      }

      .chat-modal .modal-content {
        margin: 1rem;
        max-height: 80vh;
      }
    }

    @media (max-width: 480px) {
      .page-header h1 {
        font-size: 1.5rem;
      }

      .community-card {
        border-radius: 10px;
      }

      .modal-content {
        padding: 1.5rem;
        width: 95%;
      }

      .members-list {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav>
    <a href="index.html" class="logo">Tribly</a>
    <ul class="nav-links">
      <li><a href="home.html">Ø§Ù„ØªØµÙØ­</a></li>
      <li><a href="communities.html" style="color: #6ae44d;">Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª</a></li>
      <li><a href="faq.html">Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</a></li>
      <li><a href="support.html">Ø§Ù„Ø¯Ø¹Ù…</a></li>
      <li><a href="about.html">Ø­ÙˆÙ„</a></li>
    </ul>
    <div class="nav-actions">
      <div class="user-section">
        <div class="user-avatar" id="userAvatar" onclick="toggleUserMenu()">?</div>
        <button class="auth-btn" id="authBtn" onclick="showAuthModal()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      </div>
      <button class="menu-btn" id="menuBtn" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">
        <i class="fas fa-bars"></i>
      </button>
    </div>
  </nav>

  <!-- Auth Modal -->
  <div class="modal" id="authModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Tribly</h2>
        <button class="close-btn" onclick="hideAuthModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 1.5rem; color: #666; text-align: center;">Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª ÙˆØ§Ù„ØªØ­Ø¯Ø« Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ</p>
        <div class="auth-options">
          <div class="auth-option" onclick="signInWithGoogle()">
            <div class="auth-icon">ğŸ‘¤</div>
            <div class="auth-text">
              <div class="auth-title">ØªØ³Ø¬ÙŠÙ„ Ø³Ø±ÙŠØ¹</div>
              <div class="auth-desc">Ø§Ø®ØªØ± Ø§Ø³Ù… ÙˆØ§Ø¨Ø¯Ø£ Ù…Ø¨Ø§Ø´Ø±Ø©</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <h1>ğŸŒ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª</h1>
      <p>Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ù…Ø¬ØªÙ…Ø¹Ø§Øª ØªØ´Ø§Ø±ÙƒÙƒ Ù†ÙØ³ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª</p>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
      <button class="filter-btn active" onclick="filterCommunities('all'); return false;">Ø§Ù„ÙƒÙ„</button>
      <button class="filter-btn" onclick="filterCommunities('public'); return false;">
        <i class="fas fa-globe"></i> Ø¹Ø§Ù…
      </button>
      <button class="filter-btn" onclick="filterCommunities('private'); return false;">
        <i class="fas fa-lock"></i> Ø®Ø§Øµ
      </button>
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¬ØªÙ…Ø¹..." oninput="searchCommunities(); return false;">
      </div>
      <button class="btn btn-primary" onclick="showCreateModal(); return false;" style="width: auto;">
        <i class="fas fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬ØªÙ…Ø¹
      </button>
    </div>

    <!-- Communities Grid -->
    <div class="communities-grid" id="communitiesGrid">
      <div class="loading">
        <div class="loading-spinner"></div>
        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª...</p>
      </div>
    </div>
  </div>

  <!-- Create/Edit Community Modal -->
  <div class="modal" id="createModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬ØªÙ…Ø¹ Ø¬Ø¯ÙŠØ¯</h2>
        <button class="close-btn" onclick="hideCreateModal()">Ã—</button>
      </div>
      <form id="communityForm">
        <div class="form-group">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ *</label>
          <input type="text" id="communityName" required>
        </div>

        <div class="form-group">
          <label>Ø§Ù„ÙˆØµÙ *</label>
          <textarea id="communityDesc" required></textarea>
        </div>

        <div class="form-group">
          <label>Ø§Ù„Ù†ÙˆØ¹ *</label>
          <select id="communityType" style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;" onchange="togglePasswordField()">
            <option value="public">Ø¹Ø§Ù… (Ù…ÙØªÙˆØ­ Ù„Ù„Ø¬Ù…ÙŠØ¹)</option>
            <option value="private">Ø®Ø§Øµ (ÙŠØªØ·Ù„Ø¨ ÙƒÙ„Ù…Ø© Ø³Ø±)</option>
          </select>
        </div>

        <div class="form-group" id="passwordGroup" style="display: none;">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± *</label>
          <input type="password" id="communityPassword" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± Ù‚ÙˆÙŠØ©">
        </div>

        <div class="form-group">
          <label>Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© (Ø±Ù…Ø² ØªØ¹Ø¨ÙŠØ±ÙŠ)</label>
          <input type="text" id="communityIcon" placeholder="Ù…Ø«Ø§Ù„: ğŸ® ğŸµ âš½" value="ğŸ‘¥">
        </div>

        <button type="submit" class="btn btn-primary" style="width: 100%;">
          Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹
        </button>
      </form>
    </div>
  </div>

  <!-- Community Detail/Chat Modal -->
  <div class="modal chat-modal" id="chatModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="chatTitle">Ø§Ø³Ù… Ø§Ù„Ù…Ø¬ØªÙ…Ø¹</h2>
        <button class="close-btn" onclick="hideChatModal()">Ã—</button>
      </div>
      <div class="community-detail" id="chatContent">
        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø£Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
      </div>
    </div>
  </div>

  <!-- Join Private Community Modal -->
  <div class="modal" id="joinModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ Ù…Ø¬ØªÙ…Ø¹ Ø®Ø§Øµ</h2>
        <button class="close-btn" onclick="hideJoinModal()">Ã—</button>
      </div>
      <form id="joinForm">
        <div class="form-group">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <input type="password" id="joinPassword" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">
          Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
        </button>
      </form>
    </div>
  </div>

  <!-- Footer -->
  <footer style="background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%); color: #6ae44d; padding: 3rem 2rem; text-align: center; margin-top: 3rem;">
    <div style="max-width: 1200px; margin: 0 auto;">
      <h3 style="color: #6ae44d; margin-bottom: 1rem; text-shadow: 0 0 10px rgba(106, 228, 77, 0.3);">Tribly</h3>
      <p style="margin-bottom: 1.5rem; color: #ccc;">Ø£ÙˆØ¬Ø¯ Ù‚Ø¨ÙŠÙ„ØªÙƒ - Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ù…Ø¬ØªÙ…Ø¹Ø§Øª ØªØ´Ø§Ø±ÙƒÙƒ Ù†ÙØ³ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª</p>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
        <div>
          <h4 style="color: #6ae44d; margin-bottom: 1rem;">Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h4>
          <ul style="list-style: none; padding: 0;">
            <li style="margin-bottom: 0.5rem;"><a href="index.html" style="color: #ccc; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#6ae44d'" onmouseout="this.style.color='#ccc'">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
            <li style="margin-bottom: 0.5rem;"><a href="home.html" style="color: #ccc; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#6ae44d'" onmouseout="this.style.color='#ccc'">Ø§Ù„ØªØµÙØ­</a></li>
            <li style="margin-bottom: 0.5rem;"><a href="communities.html" style="color: #ccc; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#6ae44d'" onmouseout="this.style.color='#ccc'">Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª</a></li>
            <li style="margin-bottom: 0.5rem;"><a href="profile.html" style="color: #ccc; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#6ae44d'" onmouseout="this.style.color='#ccc'">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</a></li>
          </ul>
        </div>
        <div>
          <h4 style="color: #6ae44d; margin-bottom: 1rem;">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h4>
          <ul style="list-style: none; padding: 0;">
            <li style="margin-bottom: 0.5rem;"><a href="about.html" style="color: #ccc; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#6ae44d'" onmouseout="this.style.color='#ccc'">Ø­ÙˆÙ„</a></li>
            <li style="margin-bottom: 0.5rem;"><a href="manifesto.html" style="color: #ccc; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#6ae44d'" onmouseout="this.style.color='#ccc'">Ø§Ù„Ø¨ÙŠØ§Ù†</a></li>
            <li style="margin-bottom: 0.5rem;"><a href="privacy.html" style="color: #ccc; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#6ae44d'" onmouseout="this.style.color='#ccc'">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a></li>
            <li style="margin-bottom: 0.5rem;"><a href="service.html" style="color: #ccc; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#6ae44d'" onmouseout="this.style.color='#ccc'">Ø´Ø±ÙˆØ· Ø§Ù„Ø®Ø¯Ù…Ø©</a></li>
          </ul>
        </div>
        <div>
          <h4 style="color: #6ae44d; margin-bottom: 1rem;">Ø§Ù„Ø¯Ø¹Ù…</h4>
          <ul style="list-style: none; padding: 0;">
            <li style="margin-bottom: 0.5rem;"><a href="support-site.html" style="color: #ccc; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#6ae44d'" onmouseout="this.style.color='#ccc'">Ù…Ø±ÙƒØ² Ø§Ù„Ø¯Ø¹Ù…</a></li>
            <li style="margin-bottom: 0.5rem;"><a href="contact-us.html" style="color: #ccc; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#6ae44d'" onmouseout="this.style.color='#ccc'">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</a></li>
          </ul>
        </div>
      </div>
      <div style="border-top: 1px solid rgba(106, 228, 77, 0.3); padding-top: 1.5rem; color: #999;">
        <p>&copy; 2025 Tribly - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p>
      </div>
    </div>
  </footer>

  <!-- Main JavaScript -->
  <script>
    // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
    let currentUser = null;
    let communities = {};
    let currentCommunityId = null;
    let currentFilter = 'all';
    let joinedCommunities = {};
    let messageListener = null;

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    window.initApp = async function() {
      try {
        console.log("ğŸš€ Starting app initialization...");
        
        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
        window.firebase.authFunctions.onAuthStateChanged(window.firebase.auth, async (user) => {
          if (user) {
            await handleUserSignedIn(user);
          } else {
            handleUserSignedOut();
          }
        });
        
      } catch (error) {
        console.error("âŒ App initialization error:", error);
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚');
      }
    };

    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    async function handleUserSignedIn(user) {
      try {
        currentUser = {
          uid: user.uid,
          name: user.displayName || user.email?.split('@')[0] || 'Ù…Ø³ØªØ®Ø¯Ù…',
          email: user.email,
          avatar: user.photoURL || (user.displayName ? user.displayName.charAt(0).toUpperCase() : '?')
        };
        
        console.log("âœ… User signed in:", currentUser.name);
        
        updateUserUI();
        await loadAllData();
        hideAuthModal();
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
        checkUrlForCommunity();
        
      } catch (error) {
        console.error("âŒ Error handling sign in:", error);
      }
    }

    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    function handleUserSignedOut() {
      console.log("ğŸ‘‹ User signed out");
      
      currentUser = null;
      communities = {};
      joinedCommunities = {};
      currentCommunityId = null;
      
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
      if (messageListener) {
        messageListener();
        messageListener = null;
      }
      
      updateUserUI();
      renderCommunities();
    }

    // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async function loadAllData() {
      try {
        showCommunitiesLoading();
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª
        await loadCommunities();
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª Ø§Ù„Ù…Ù†Ø¶Ù… Ù„Ù‡Ø§
        if (currentUser) {
          await loadJoinedCommunities();
        }
        
        renderCommunities();
        
      } catch (error) {
        console.error("âŒ Error loading data:", error);
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª Ù…Ù† Firebase
    async function loadCommunities() {
      try {
        const dbRef = window.firebase.db.ref(window.firebase.database, 'communities');
        const snapshot = await window.firebase.db.get(dbRef);
        
        if (snapshot.exists()) {
          communities = snapshot.val();
          console.log("ğŸ“Š Loaded", Object.keys(communities).length, "communities");
        } else {
          communities = {};
          console.log("â„¹ï¸ No communities found");
        }
      } catch (error) {
        console.error("âŒ Error loading communities:", error);
        throw error;
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª Ø§Ù„Ù…Ù†Ø¶Ù… Ù„Ù‡Ø§
    async function loadJoinedCommunities() {
      try {
        const dbRef = window.firebase.db.ref(window.firebase.database, `userCommunities/${currentUser.uid}`);
        const snapshot = await window.firebase.db.get(dbRef);
        
        if (snapshot.exists()) {
          joinedCommunities = snapshot.val();
          console.log("ğŸ“‹ User joined", Object.keys(joinedCommunities).length, "communities");
        } else {
          joinedCommunities = {};
        }
      } catch (error) {
        console.error("âŒ Error loading joined communities:", error);
      }
    }

    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    function updateUserUI() {
      const avatar = document.getElementById('userAvatar');
      const authBtn = document.getElementById('authBtn');
      
      if (currentUser) {
        avatar.textContent = currentUser.avatar;
        authBtn.textContent = currentUser.name;
        avatar.title = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.name}`;
      } else {
        avatar.textContent = '?';
        authBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
        avatar.title = 'Ø²Ø§Ø¦Ø±';
      }
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª
    function renderCommunities() {
      const grid = document.getElementById('communitiesGrid');
      
      if (!communities || Object.keys(communities).length === 0) {
        grid.innerHTML = `
          <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
            <div style="font-size: 48px; margin-bottom: 20px;">ğŸ¢</div>
            <h3 style="color: #4a5568; margin-bottom: 10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬ØªÙ…Ø¹Ø§Øª Ø¨Ø¹Ø¯</h3>
            <p style="color: #718096;">${currentUser ? 'ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠÙ†Ø´Ø¦ Ù…Ø¬ØªÙ…Ø¹Ø§Ù‹!' : 'Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØªØ±Ù‰ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª'}</p>
          </div>
        `;
        return;
      }

      let filteredCommunities = Object.entries(communities);

      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ©
      if (currentFilter === 'public') {
        filteredCommunities = filteredCommunities.filter(([id, community]) => community.type === 'public');
      } else if (currentFilter === 'private') {
        filteredCommunities = filteredCommunities.filter(([id, community]) => community.type === 'private');
      }

      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø«
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      if (searchTerm) {
        filteredCommunities = filteredCommunities.filter(([id, community]) =>
          community.name.toLowerCase().includes(searchTerm) ||
          (community.desc || '').toLowerCase().includes(searchTerm)
        );
      }

      // ÙØ±Ø² Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
      filteredCommunities.sort((a, b) => (b[1].createdAt || 0) - (a[1].createdAt || 0));

      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒØ±ÙˆØª
      let html = '';
      filteredCommunities.forEach(([id, community]) => {
        const isJoined = currentUser && joinedCommunities && joinedCommunities[id];
        
        html += `
          <div class="community-card">
            <div class="community-header ${community.type}">
              <div class="community-badge ${community.type}">
                ${community.type === 'public' ? 'ğŸŒ Ø¹Ø§Ù…' : 'ğŸ”’ Ø®Ø§Øµ'}
              </div>
              <div class="community-icon">${community.icon || 'ğŸ‘¥'}</div>
            </div>
            <div class="community-info">
              <div class="community-name">${community.name}</div>
              <div class="community-desc">${community.desc || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</div>
              <div class="community-stats">
                <div class="stat">
                  <div class="stat-number">${community.members || 1}</div>
                  <div class="stat-label">Ø¹Ø¶Ùˆ</div>
                </div>
                <div class="stat">
                  <div class="stat-number">${community.posts || community.messageCount || 0}</div>
                  <div class="stat-label">Ø±Ø³Ø§Ø¦Ù„</div>
                </div>
                <div class="stat">
                  <div class="stat-number">${community.createdBy ? 1 : 0}</div>
                  <div class="stat-label">Ù…Ø´Ø±Ù</div>
                </div>
              </div>
              <div class="community-footer">
                <button class="btn ${isJoined ? 'btn-secondary' : 'btn-primary'}"
                        onclick="handleCommunityAction('${id}')"
                        ${!currentUser ? 'disabled' : ''}>
                  <i class="fas fa-${isJoined ? 'check' : 'plus'}"></i>
                  ${isJoined ? 'Ø¹Ø¶Ùˆ' : 'Ø§Ù†Ø¶Ù… Ø§Ù„Ø¢Ù†'}
                </button>
                <button class="btn btn-secondary" onclick="showCommunityDetail('${id}')">
                  <i class="fas fa-arrow-left"></i> Ø¹Ø±Ø¶
                </button>
              </div>
            </div>
          </div>
        `;
      });

      grid.innerHTML = html || `
        <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #718096;">
          Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬ØªÙ…Ø¹Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø¨Ø­Ø«Ùƒ
        </div>
      `;
    }

    // ØªØµÙÙŠØ© Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª
    function filterCommunities(type) {
      currentFilter = type;
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø´Ø·Ø©
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      renderCommunities();
      return false;
    }

    // Ø¨Ø­Ø« Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª
    function searchCommunities() {
      renderCommunities();
      return false;
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹
    async function signInWithGoogle() {
      try {
        const userName = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ (Ù…Ù…ÙƒÙ† ØªØ®Ù„ÙŠÙ‡ Ù…Ø³ØªØ¹Ø§Ø±):');
        if (userName && userName.trim()) {
          currentUser = {
            uid: Date.now().toString(),
            name: userName.trim(),
            avatar: userName.charAt(0).toUpperCase()
          };
          
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          updateUserUI();
          hideAuthModal();
          showSuccess(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${userName}!`);
          
          // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          await loadAllData();
        }
      } catch (error) {
        console.error("âŒ Sign in error:", error);
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
      }
    }

    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù†Ø¶Ù…Ø§Ù…/Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ù…Ø¬ØªÙ…Ø¹
    async function handleCommunityAction(communityId) {
      if (!currentUser) {
        showAuthModal();
        return;
      }

      const community = communities[communityId];
      if (!community) return;

      const isJoined = joinedCommunities && joinedCommunities[communityId];

      if (isJoined) {
        // Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ù…Ø¬ØªÙ…Ø¹
        if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…ØºØ§Ø¯Ø±Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ØŸ')) {
          await leaveCommunity(communityId);
        }
      } else {
        // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù…Ø¬ØªÙ…Ø¹
        if (community.type === 'private') {
          currentCommunityId = communityId;
          showJoinModal();
        } else {
          await joinCommunity(communityId);
        }
      }
    }

    // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù…Ø¬ØªÙ…Ø¹
    async function joinCommunity(communityId) {
      try {
        const communityRef = window.firebase.db.ref(window.firebase.database, `communities/${communityId}`);
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
        const community = communities[communityId];
        const newMemberCount = (community.members || 1) + 1;
        
        await window.firebase.db.update(communityRef, {
          members: newMemberCount
        });

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª Ø§Ù„Ù…Ù†Ø¶Ù… Ù„Ù‡Ø§
        const userCommunityRef = window.firebase.db.ref(window.firebase.database, `userCommunities/${currentUser.uid}/${communityId}`);
        await window.firebase.db.set(userCommunityRef, true);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        communities[communityId].members = newMemberCount;
        joinedCommunities[communityId] = true;
        
        renderCommunities();
        showSuccess('ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù…Ø¬ØªÙ…Ø¹ Ø¨Ù†Ø¬Ø§Ø­!');
        
        // ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        showCommunityDetail(communityId);
        
      } catch (error) {
        console.error("âŒ Error joining community:", error);
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…');
      }
    }

    // Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ù…Ø¬ØªÙ…Ø¹
    async function leaveCommunity(communityId) {
      try {
        const communityRef = window.firebase.db.ref(window.firebase.database, `communities/${communityId}`);
        
        // ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
        const community = communities[communityId];
        const newMemberCount = Math.max(0, (community.members || 1) - 1);
        
        await window.firebase.db.update(communityRef, {
          members: newMemberCount
        });

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª Ø§Ù„Ù…Ù†Ø¶Ù… Ù„Ù‡Ø§
        const userCommunityRef = window.firebase.db.ref(window.firebase.database, `userCommunities/${currentUser.uid}/${communityId}`);
        await window.firebase.db.remove(userCommunityRef);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        communities[communityId].members = newMemberCount;
        delete joinedCommunities[communityId];
        
        renderCommunities();
        showSuccess('ØªÙ… Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ù…Ø¬ØªÙ…Ø¹');
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
        if (currentCommunityId === communityId) {
          hideChatModal();
        }
        
      } catch (error) {
        console.error("âŒ Error leaving community:", error);
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©');
      }
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬ØªÙ…Ø¹ Ø¬Ø¯ÙŠØ¯
    document.getElementById('communityForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!currentUser) {
        showAuthModal();
        return;
      }
      
      const name = document.getElementById('communityName').value.trim();
      const description = document.getElementById('communityDesc').value.trim();
      const type = document.getElementById('communityType').value;
      const password = type === 'private' ? document.getElementById('communityPassword').value : null;
      
      if (!name) {
        showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬ØªÙ…Ø¹');
        return;
      }
      
      if (type === 'private' && !password) {
        showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± Ù„Ù„Ù…Ø¬ØªÙ…Ø¹ Ø§Ù„Ø®Ø§Øµ');
        return;
      }
      
      try {
        const communityId = Date.now().toString();
        const communityRef = window.firebase.db.ref(window.firebase.database, `communities/${communityId}`);
        
        const newCommunity = {
          id: communityId,
          name: name,
          desc: description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ',
          type: type,
          icon: document.getElementById('communityIcon').value || 'ğŸ‘¥',
          members: 1,
          posts: 0,
          messageCount: 0,
          createdAt: Date.now(),
          createdBy: currentUser.uid,
          createdByName: currentUser.name
        };
        
        if (type === 'private' && password) {
          newCommunity.password = password;
        }
        
        // Ø­ÙØ¸ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ ÙÙŠ Firebase
        await window.firebase.db.set(communityRef, newCommunity);
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒØ¹Ø¶Ùˆ
        const userCommunityRef = window.firebase.db.ref(window.firebase.database, `userCommunities/${currentUser.uid}/${communityId}`);
        await window.firebase.db.set(userCommunityRef, true);
        
        // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨
        const messageRef = window.firebase.db.ref(window.firebase.database, `messages/${communityId}`);
        await window.firebase.db.push(messageRef, {
          userId: 'system',
          userName: 'Ø§Ù„Ù†Ø¸Ø§Ù…',
          text: `ğŸ‰ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ "${name}" Ø¨ÙˆØ§Ø³Ø·Ø© ${currentUser.name}!`,
          timestamp: Date.now(),
          type: 'system'
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        await window.firebase.db.update(communityRef, {
          messageCount: 1
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        communities[communityId] = newCommunity;
        joinedCommunities[communityId] = true;
        
        hideCreateModal();
        renderCommunities();
        showSuccess(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ "${name}" Ø¨Ù†Ø¬Ø§Ø­!`);
        
        // ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        setTimeout(() => showCommunityDetail(communityId), 500);
        
      } catch (error) {
        console.error("âŒ Error creating community:", error);
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹');
      }
    });

    // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹
    async function showCommunityDetail(communityId) {
      const community = communities[communityId];
      if (!community) return;
      
      currentCommunityId = communityId;
      const isJoined = currentUser && joinedCommunities && joinedCommunities[communityId];
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
      document.getElementById('chatTitle').textContent = community.name;
      
      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
      const messages = await loadMessages(communityId);
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
      const link = `${window.location.origin}${window.location.pathname}?community=${communityId}`;
      
      let membersHtml = '';
      if (community.createdByName) {
        membersHtml = `
          <div class="member-card">
            <div class="member-avatar">${community.createdByName.charAt(0)}</div>
            <div class="member-name">${community.createdByName}</div>
            <div class="member-role">Ù…Ø¤Ø³Ø³ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹</div>
          </div>
        `;
      }
      
      let messagesHtml = '';
      if (messages && messages.length > 0) {
        messagesHtml = messages.map(msg => {
          const isSystem = msg.type === 'system';
          return `
            <div class="message ${isSystem ? 'system' : ''}">
              <div class="message-header">
                <span class="message-author">${msg.userName}</span>
                <span class="message-time">${formatTime(msg.timestamp)}</span>
              </div>
              <div class="message-content">${msg.text}</div>
            </div>
          `;
        }).join('');
      }
      
      const canMessage = isJoined;
      
      document.getElementById('chatContent').innerHTML = `
        <div class="detail-header ${community.type}">
          <h1>${community.icon || 'ğŸ‘¥'} ${community.name}</h1>
          <p>${community.desc || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</p>
        </div>
        <div class="detail-content">
          ${isJoined ? `
          <div class="share-section">
            <div class="share-header">
              <i class="fas fa-share-alt"></i> Ø´Ø§Ø±Ùƒ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ
            </div>
            <div class="share-box">
              <input type="text" value="${link}" readonly id="communityLinkInput">
              <button class="copy-btn" onclick="copyCommunityLink('${link}')">
                <i class="fas fa-copy"></i> Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
              </button>
            </div>
          </div>
          ` : ''}
          
          <div class="detail-section">
            <h3>â„¹ï¸ Ø­ÙˆÙ„ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹</h3>
            <p><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${community.type === 'public' ? 'ğŸŒ Ø¹Ø§Ù…' : 'ğŸ”’ Ø®Ø§Øµ'}</p>
            <p><strong>Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡:</strong> ${community.members || 1}</p>
            <p><strong>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:</strong> ${community.messageCount || 0}</p>
            <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</strong> ${formatDate(community.createdAt)}</p>
          </div>

          <div class="detail-section">
            <h3>ğŸ‘¥ Ø§Ù„Ù…Ø´Ø±ÙÙˆÙ†</h3>
            <div class="members-list">
              ${membersHtml || '<p style="color: #999; text-align: center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</p>'}
            </div>
          </div>

          <div class="detail-section">
            <h3>ğŸ’¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h3>
            <div class="chat-section">
              <div class="chat-container" id="chatContainer">
                ${messagesHtml || '<p style="text-align: center; color: #999; padding: 2rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯</p>'}
              </div>
              ${isJoined ? `
              <div class="message-input">
                <input type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." id="msgInput" onkeypress="handleEnter(event, '${communityId}')">
                <button onclick="sendMessage('${communityId}')">Ø¥Ø±Ø³Ø§Ù„</button>
              </div>
              ` : '<p style="color: #999; font-size: 0.9rem; text-align: center; padding: 1rem; background: #f5f5f5; border-radius: 8px;">Ø§Ù†Ø¶Ù… Ù„Ù„Ù…Ø¬ØªÙ…Ø¹ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</p>'}
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('chatModal').classList.add('active');
      
      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      setupMessageListener(communityId);
      
      // ØªÙ…Ø±ÙŠØ± Ø§Ù„ØªØ±ÙƒÙŠØ² Ù„Ù„Ø±Ø³Ø§Ø¦Ù„
      setTimeout(() => {
        const container = document.getElementById('chatContainer');
        if (container) {
          container.scrollTop = container.scrollHeight;
        }
      }, 100);
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    async function loadMessages(communityId) {
      try {
        const dbRef = window.firebase.db.ref(window.firebase.database, `messages/${communityId}`);
        const snapshot = await window.firebase.db.get(dbRef);
        
        if (snapshot.exists()) {
          const messages = snapshot.val();
          return Object.values(messages).sort((a, b) => a.timestamp - b.timestamp);
        }
        return [];
      } catch (error) {
        console.error("âŒ Error loading messages:", error);
        return [];
      }
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    function setupMessageListener(communityId) {
      if (messageListener) {
        messageListener();
      }
      
      const dbRef = window.firebase.db.ref(window.firebase.database, `messages/${communityId}`);
      messageListener = window.firebase.db.onChildAdded(dbRef, (snapshot) => {
        const msg = snapshot.val();
        const container = document.getElementById('chatContainer');
        
        if (container && !container.innerHTML.includes('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„')) {
          const isSystem = msg.type === 'system';
          const messageHtml = `
            <div class="message ${isSystem ? 'system' : ''}">
              <div class="message-header">
                <span class="message-author">${msg.userName}</span>
                <span class="message-time">${formatTime(msg.timestamp)}</span>
              </div>
              <div class="message-content">${msg.text}</div>
            </div>
          `;
          
          container.innerHTML += messageHtml;
          container.scrollTop = container.scrollHeight;
        }
      });
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
    async function sendMessage(communityId) {
      if (!currentUser || !communityId) return;
      
      const input = document.getElementById('msgInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      if (!joinedCommunities[communityId]) {
        showError('ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù…Ø¬ØªÙ…Ø¹ Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }
      
      try {
        const messageRef = window.firebase.db.ref(window.firebase.database, `messages/${communityId}`);
        
        await window.firebase.db.push(messageRef, {
          userId: currentUser.uid,
          userName: currentUser.name,
          text: message,
          timestamp: Date.now(),
          type: 'message'
        });

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        const communityRef = window.firebase.db.ref(window.firebase.database, `communities/${communityId}`);
        const community = communities[communityId];
        const newMessageCount = (community.messageCount || 0) + 1;
        
        await window.firebase.db.update(communityRef, {
          messageCount: newMessageCount
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        communities[communityId].messageCount = newMessageCount;
        
        input.value = '';
        input.focus();
        
      } catch (error) {
        console.error("âŒ Error sending message:", error);
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
      }
    }

    // Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¬ØªÙ…Ø¹
    function copyCommunityLink(link) {
      navigator.clipboard.writeText(link)
        .then(() => {
          const btn = event.target;
          btn.innerHTML = '<i class="fas fa-check"></i> ØªÙ… Ø§Ù„Ù†Ø³Ø®!';
          btn.classList.add('copied');
          setTimeout(() => {
            btn.innerHTML = '<i class="fas fa-copy"></i> Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·';
            btn.classList.remove('copied');
          }, 2000);
        })
        .catch(err => {
          showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·');
        });
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
    function checkUrlForCommunity() {
      const urlParams = new URLSearchParams(window.location.search);
      const communityId = urlParams.get('community');
      
      if (communityId && communities[communityId]) {
        const community = communities[communityId];
        
        if (community.type === 'public') {
          showCommunityDetail(communityId);
        } else if (currentUser && joinedCommunities[communityId]) {
          showCommunityDetail(communityId);
        } else {
          currentCommunityId = communityId;
          setTimeout(() => showJoinModal(), 1000);
        }
      }
    }

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Enter
    function handleEnter(event, communityId) {
      if (event.key === 'Enter') {
        sendMessage(communityId);
      }
    }

    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
    function formatTime(timestamp) {
      if (!timestamp) return 'Ø§Ù„Ø¢Ù†';
      
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      const seconds = Math.floor(diff / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);
      
      if (seconds < 60) return 'Ø§Ù„Ø¢Ù†';
      if (minutes < 60) return `Ù‚Ø¨Ù„ ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
      if (hours < 24) return `Ù‚Ø¨Ù„ ${hours} Ø³Ø§Ø¹Ø©`;
      if (days < 7) return `Ù‚Ø¨Ù„ ${days} ÙŠÙˆÙ…`;
      
      return date.toLocaleDateString('ar-SA');
    }

    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
    function formatDate(timestamp) {
      if (!timestamp) return 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
      return new Date(timestamp).toLocaleDateString('ar-SA');
    }

    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ø±Ø¶/Ø§Ù„Ø¥Ø®ÙØ§Ø¡
    function showAuthModal() {
      document.getElementById('authModal').classList.add('active');
    }

    function hideAuthModal() {
      document.getElementById('authModal').classList.remove('active');
    }

    function showCreateModal() {
      if (!currentUser) {
        showAuthModal();
        return;
      }
      document.getElementById('createModal').classList.add('active');
    }

    function hideCreateModal() {
      document.getElementById('createModal').classList.remove('active');
      document.getElementById('communityForm').reset();
      document.getElementById('passwordGroup').style.display = 'none';
    }

    function showJoinModal() {
      if (!currentUser) {
        showAuthModal();
        return;
      }
      document.getElementById('joinModal').classList.add('active');
    }

    function hideJoinModal() {
      document.getElementById('joinModal').classList.remove('active');
      document.getElementById('joinPassword').value = '';
    }

    function hideChatModal() {
      document.getElementById('chatModal').classList.remove('active');
      currentCommunityId = null;
      if (messageListener) {
        messageListener();
        messageListener = null;
      }
    }

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù…Ø¬ØªÙ…Ø¹ Ø®Ø§Øµ
    document.getElementById('joinForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!currentUser || !currentCommunityId) return;
      
      const password = document.getElementById('joinPassword').value;
      const community = communities[currentCommunityId];
      
      if (community.password === password) {
        await joinCommunity(currentCommunityId);
        hideJoinModal();
      } else {
        showError('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
      }
    });

    function togglePasswordField() {
      const type = document.getElementById('communityType').value;
      document.getElementById('passwordGroup').style.display = type === 'private' ? 'block' : 'none';
    }

    function showCommunitiesLoading() {
      const grid = document.getElementById('communitiesGrid');
      grid.innerHTML = `
        <div class="loading" style="grid-column: 1/-1;">
          <div class="loading-spinner"></div>
          <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª...</p>
        </div>
      `;
    }

    function showError(message) {
      alert(`âŒ ${message}`);
    }

    function showSuccess(message) {
      alert(`âœ… ${message}`);
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†ÙˆØ§ÙØ°
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.remove('active');
          if (this.id === 'chatModal') {
            currentCommunityId = null;
            if (messageListener) {
              messageListener();
              messageListener = null;
            }
          }
        }
      });
    });

    console.log("ğŸš€ App initialized and ready!");
  </script>
</body>
</html>