<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>المحادثة | Tribly</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #6ae44d;
            --primary-dark: #4cb93b;
            --bg-color: #e5e5e5;
            --bubble-me: #6ae44d;
            --bubble-other: #ffffff;
            --text-me: #ffffff;
            --text-other: #2d3436;
            --header-h: 60px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }

        body {
            background-color: #dceadd; 
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%236ae44d' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            height: var(--header-h);
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 100;
            color: white;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-grow: 1;
            cursor: pointer;
        }

        .back-btn {
            font-size: 1.2rem;
            color: white;
            cursor: pointer;
            padding: 5px;
            margin-left: 5px;
        }

        .community-avatar {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: white;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.3);
        }
        .community-avatar img { width: 100%; height: 100%; object-fit: cover; }

        .community-details h3 { font-size: 1rem; margin-bottom: 2px; }
        .community-details span { font-size: 0.75rem; opacity: 0.9; }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .icon-btn {
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            transition: 0.2s;
        }
        .icon-btn:hover { color: #e0f7fa; }

        /* --- Chat Area --- */
        .chat-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            scroll-behavior: smooth;
        }

        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }

        /* Messages */
        .message-row {
            display: flex;
            width: 100;
            margin-bottom: 5px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .message-row.sent { justify-content: flex-end; }
        .message-row.received { justify-content: flex-start; }

        .bubble {
            max-width: 75%;
            padding: 8px 12px;
            border-radius: 12px;
            position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            font-size: 0.95rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message-row.sent .bubble {
            background: var(--bubble-me);
            color: var(--text-me);
            border-top-left-radius: 2px;
        }

        .message-row.received .bubble {
            background: var(--bubble-other);
            color: var(--text-other);
            border-top-right-radius: 2px;
        }

        .sender-name {
            font-size: 0.75rem;
            color: var(--primary-dark);
            margin-bottom: 4px;
            font-weight: 700;
            display: block;
        }

        .meta {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 5px;
            font-size: 0.7rem;
            margin-top: 4px;
            opacity: 0.8;
        }

        .read-receipt { font-size: 0.7rem; color: rgba(255,255,255,0.7); }
        .read-receipt.read { color: #53bdeb; } /* Blue ticks simulation */

        /* --- Input Area --- */
        .input-area {
            background: #f0f0f0;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            min-height: 60px;
        }

        .action-icon {
            color: #888;
            font-size: 1.4rem;
            cursor: pointer;
            padding: 5px;
        }

        .input-wrapper {
            flex-grow: 1;
            background: white;
            border-radius: 25px;
            padding: 2px 5px 2px 15px;
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
        }

        .input-wrapper input {
            flex-grow: 1;
            border: none;
            outline: none;
            padding: 12px 5px;
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
        }

        .send-btn {
            background: var(--primary);
            color: white;
            width: 40px; height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 2px 5px rgba(106, 228, 77, 0.3);
        }
        .send-btn:hover { transform: scale(1.05); }
        .send-btn:active { transform: scale(0.95); }
        .send-btn.locked {
            background: #b2bec3;
            cursor: not-allowed;
            box-shadow: none;
        }

        .system-msg {
            text-align: center;
            background: rgba(0,0,0,0.05);
            padding: 5px 15px;
            border-radius: 10px;
            align-self: center;
            font-size: 0.8rem;
            color: #666;
            margin: 10px 0;
            max-width: 80%;
        }

        .toast {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            opacity: 0;
            transition: 0.3s;
            pointer-events: none;
            z-index: 200;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        @media (max-width: 480px) {
            .bubble { max-width: 85%; }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="back-btn" onclick="window.location.href='communities.html'">
            <i class="fas fa-arrow-right"></i>
        </div>
        
        <div class="header-info">
            <div class="community-avatar">
                <img src="" id="headerImg" alt="Group">
            </div>
            <div class="community-details">
                <h3 id="headerName">...</h3>
                <span id="headerStatus">نشط</span>
            </div>
        </div>

        <div class="header-controls">
            <!-- Admin Lock Button -->
            <div id="lockBtn" class="icon-btn" onclick="toggleLock()" title="قفل المحادثة">
                <i class="fas fa-lock-open"></i>
            </div>
            
            <div class="icon-btn"><i class="fas fa-ellipsis-v"></i></div>
        </div>
    </header>

    <!-- Chat Area -->
    <main class="chat-container" id="chatContainer">
        <div style="text-align:center; padding:20px; color:#999;">
            <i class="fas fa-spinner fa-spin"></i> جاري التحميل...
        </div>
    </main>

    <!-- Input Area -->
    <footer class="input-area">
        <div class="action-icon"><i class="far fa-smile"></i></div>
        <div class="input-wrapper">
            <input type="text" id="messageInput" placeholder="اكتب رسالة..." autocomplete="off">
        </div>
        
        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
            <i class="fas fa-paper-plane"></i>
        </button>
    </footer>

    <!-- Toast -->
    <div class="toast" id="toast">تمت العملية</div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // ============================================================
        // مهم جداً: انسخ إعداداتك من Firebase Console هنا
        // ============================================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };
        // ============================================================

        // Initialize Firebase
        try {
            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);

            // --- State ---
            const urlParams = new URLSearchParams(window.location.search);
            const communityId = urlParams.get('id') || 1;
            
            const communities = {
                1: { name: "جيمرز الإسكندرية", img: "https://images.unsplash.com/photo-1542751371-adc38448a05e?auto=format&fit=crop&w=150&q=80" },
                2: { name: "Sudan Coffee Lovers", img: "https://images.unsplash.com/photo-1497935586351-b67a49e012bf?auto=format&fit=crop&w=150&q=80" },
                3: { name: "قراء السودان", img: "https://images.unsplash.com/photo-1481627834876-b7833e8f5570?auto=format&fit=crop&w=150&q=80" },
                4: { name: "الـ Tribly Secret", img: "https://images.unsplash.com/photo-1511632765486-a01980e01a18?auto=format&fit=crop&w=150&q=80" }
            };

            // Get User (Simulated Admin/User toggle for demo purposes)
            let currentUser = localStorage.getItem("tribble_user") || "زائر" + Math.floor(Math.random()*100);
            let isChatLocked = false;

            // --- DOM Elements ---
            const chatContainer = document.getElementById('chatContainer');
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');

            // --- Initialization ---
            window.onload = () => {
                loadCommunityHeader();
                listenForMessages();
                listenForLockStatus();
                
                document.getElementById('messageInput').addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') sendMessage();
                });
            };

            function loadCommunityHeader() {
                const comm = communities[communityId];
                if(comm) {
                    document.getElementById('headerName').textContent = comm.name;
                    document.getElementById('headerImg').src = comm.img;
                }
            }

            // --- REAL-TIME LISTENING (Receiving Messages) ---
            function listenForMessages() {
                const messagesRef = ref(db, 'communities/' + communityId + '/messages');
                
                onValue(messagesRef, (snapshot) => {
                    const data = snapshot.val();
                    chatContainer.innerHTML = ''; // Clear current view
                    
                    if (data) {
                        const messagesList = Object.entries(data).map(([key, val]) => ({
                            id: key,
                            ...val
                        }));
                        
                        // Sort by timestamp
                        messagesList.sort((a, b) => a.timestamp - b.timestamp);

                        messagesList.forEach(msg => {
                            // Determine if this message is from "Me" or "Them"
                            const isMe = (msg.sender === currentUser);
                            
                            const row = document.createElement('div');
                            row.className = `message-row ${isMe ? 'sent' : 'received'}`;
                            
                            const senderName = !isMe ? `<span class="sender-name">${msg.sender}</span>` : '';
                            
                            // Format time (Firebase stores timestamp as ms)
                            const time = new Date(msg.timestamp).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });

                            row.innerHTML = `
                                <div class="bubble">
                                    ${senderName}
                                    ${msg.text}
                                    <div class="meta">
                                        <span>${time}</span>
                                        ${isMe ? '<i class="fas fa-check-double read-receipt read"></i>' : ''}
                                    </div>
                                </div>
                            `;
                            chatContainer.appendChild(row);
                        });
                        scrollToBottom();
                    } else {
                        chatContainer.innerHTML = '<div class="system-msg">ابدأ المحادثة الآن</div>';
                    }
                });
            }

            // --- SEND MESSAGE ---
            window.sendMessage = function() {
                const text = messageInput.value.trim();

                if (isChatLocked) {
                    showToast("تم قفل المحادثة", "error");
                    return;
                }

                if (!text) return;

                const messagesRef = ref(db, 'communities/' + communityId + '/messages');
                const newMessageRef = push(messagesRef);
                
                set(newMessageRef, {
                    sender: currentUser,
                    text: text,
                    timestamp: Date.now() // Using local timestamp for simplicity
                });

                messageInput.value = '';
                scrollToBottom();
            }

            // --- ADMIN LOCK LOGIC (Firebase Sync) ---
            function listenForLockStatus() {
                const lockRef = ref(db, 'communities/' + communityId + '/settings/isLocked');
                onValue(lockRef, (snapshot) => {
                    isChatLocked = snapshot.val() || false;
                    updateLockUI();
                });
            }

            window.toggleLock = function() {
                // Demo: Only allow specific users to lock, or implement real auth later
                // For now, we allow everyone to toggle for demo
                isChatLocked = !isChatLocked;
                const lockRef = ref(db, 'communities/' + communityId + '/settings');
                set(lockRef, { isLocked: isChatLocked });
                
                showToast(isChatLocked ? "تم قفل المجموعة" : "تم فتح المجموعة", "success");
            }

            function updateLockUI() {
                const lockBtn = document.getElementById('lockBtn');
                const icon = lockBtn.querySelector('i');
                
                if (isChatLocked) {
                    icon.className = "fas fa-lock";
                    lockBtn.style.color = "#ff4757";
                    messageInput.disabled = true;
                    messageInput.placeholder = "المحادثة مغلقة";
                    sendBtn.classList.add('locked');
                } else {
                    icon.className = "fas fa-lock-open";
                    lockBtn.style.color = "white";
                    messageInput.disabled = false;
                    messageInput.placeholder = "اكتب رسالة...";
                    sendBtn.classList.remove('locked');
                }
            }

            function scrollToBottom() {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            function showToast(msg) {
                const toast = document.getElementById('toast');
                toast.textContent = msg;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            }

        } catch (error) {
            console.error("Firebase Error:", error);
            document.getElementById('chatContainer').innerHTML = `
                <div style="text-align:center; padding:20px; color:red;">
                    يرجى إعداد Firebase في الكود (استبدل YOUR_API_KEY...)
                    <br><br>
                    الخطأ: ${error.message}
                </div>
            `;
        }
    </script>
</body>
</html>